<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Code :: A new Frege IDE</title>
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">A new Frege IDE</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input
            id="search-input" 
            type="text" 
            placeholder="Search the docs"
          >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a 
            class="navbar-item" 
            href="https://github.com/tricktron/frege-vscode">Frege VS Code</a>
        <a 
            class="navbar-item" 
            href="https://github.com/tricktron/frege-lsp-server">Frege Language Server
        </a>
        <a 
            class="navbar-item" 
            href="https://github.com/tricktron/frege-gradle-plugin">Frege Gradle Plugin</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="frege-lsp-server" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">frege-lsp-server</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">A new Frege IDE</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="context.html">Context</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="functional-overview.html">Functional Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quality-attributes.html">Quality Attributes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="constraints.html">Constraints</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="principles.html">Principles</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="software-architecture.html">Software Architecture</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="code.html">Code</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">frege-lsp-server</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">frege-lsp-server</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">frege-lsp-server</a></li>
    <li><a href="code.html">Code</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tricktron/frege-lsp-server/edit/HEAD/docs/modules/ROOT/pages/code.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Code</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this Section, we want to examine how the <a href="principles.html#funcCore" class="xref page">functional core, outer shell</a> design pattern was implemented for the hover feature with the following three steps:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Impure Input</dt>
<dd>
<p>Compile Frege source code, extract and save the compiler global.</p>
</dd>
<dt class="hdlist1">Pure Core</dt>
<dd>
<p>Extract the hover information (type signature) from the extracted compiler global and transform it to the LSP hover type.</p>
</dd>
<dt class="hdlist1">Impure Output</dt>
<dd>
<p>Send the hover lsp data type back to the text editor using the LSP4J library.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="principles.html#funcCore" class="xref page">functional core, outer shell</a> design pattern generalises well:
The code for the impure input is already implemented while the code skeleton for the impure output is given by the LSP4J library. As a result, only the pure core part needs a lot of effort to implement for new language features.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_impure_input"><a class="anchor" href="#_impure_input"></a>Impure Input</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The compile component is responsible for creating an in-memory model of all available compiler information. It uses a Java <code>uriGlobals HashMap&lt;URI, Global&gt;</code> data structure to keep track of all openend Frege files in the text editor and its compiler information.</p>
</div>
<div class="paragraph">
<p>The Uniform Resource Identifier (<code>URI</code>) for each Frege file is defined by the <a href="https://microsoft.github.io/language-server-protocol/specifications/specification-3-16/#uri">language server protocol (LSP)</a>, while the <code>Global</code> data type is defined by the Frege compiler. It stores all compiler information for the associated Frege file <code>URI</code> and is documented <a href="https://github.com/Frege/frege/blob/master/frege/compiler/types/Global.fr">here</a>.</p>
</div>
<div class="paragraph">
<p><a href="#compile-component-seq">Figure 1</a> shows the sequence diagram for the compile component.</p>
</div>
<div id="compile-component-seq" class="imageblock kroki">
<div class="content">
<img src="_images/diag-01ef8f04137d30ab3847a3228e76245363a9dace.svg" alt="A code change in the text editor calls the LSP component, which delegates the call to the Compile component. The Compile component compiles the given Frege file `URI` with the initialised projectGlobal and saves all returned newGlobals in the `uriGlobals` hashmap.">
</div>
<div class="title">Figure 1. A code change in the text editor calls the LSP component, which delegates the call to the Compile component. The Compile component compiles the given Frege file <code>URI</code> with the initialised projectGlobal and saves all returned newGlobals in the <code>uriGlobals</code> hashmap.</div>
</div>
<div class="paragraph">
<p>The Compile component is layered according to the <a href="principles.html#fregeCore" class="xref page">Write Core Logic in Frege, Use Java for LSP</a> principle and shown in <a href="#compile-layer-seq">Figure 2</a>.</p>
</div>
<div id="compile-layer-seq" class="imageblock kroki">
<div class="content">
<img src="_images/diag-263f9bc9d702a67ad053dc2b721ff6e4559b3b0b.svg" alt="Compile layers: The `CompileService.java` class calls the `CompileExecutorLSP.fr` module, which calls the `CompileMakeMode.fr` module. The `CompileMakeMode.fr` is the core part, which calls the Frege compiler to compile the Frege file with the given project global. The returned list of globals is of type `IO` and thus impure. This `IO [Global]` list is then first converted by the `CompileMakeMode.fr` to `IOMutalbe (ArrayList Global)` and finally to the Java native type `List&lt;TGlobal&gt;` As a final step the `uriGlobals` hashmap is upated with the new globals.">
</div>
<div class="title">Figure 2. Compile layers: The <code>CompileService.java</code> class calls the <code>CompileExecutorLSP.fr</code> module, which calls the <code>CompileMakeMode.fr</code> module. The <code>CompileMakeMode.fr</code> is the core part, which calls the Frege compiler to compile the Frege file with the given project global. The returned list of globals is of type <code>IO</code> and thus impure. This <code>IO [Global]</code> list is then first converted by the <code>CompileMakeMode.fr</code> to <code>IOMutalbe (ArrayList Global)</code> and finally to the Java native type <code>List&lt;TGlobal&gt;</code> As a final step the <code>uriGlobals</code> hashmap is upated with the new globals.</div>
</div>
<div class="paragraph">
<p>The impure <code>compileMake :: String &#8594; Global &#8594; IO [Global]</code> is the core function. It uses a slight variation of the Frege compiler&#8217;s <a href="https://github.com/Frege/frege/wiki/Compiler-Manpage#make-mode">make mode</a>, which automatically compiles all dependent modules first. It differs only in the return type by always returning a list of globals. For this to work, the Frege compiler needs to know the common Frege main source directory, which is configured through the project global and retrieved by the <a href="software-architecture.html#_frege_language_server" class="xref page">Project component</a>. This builds the basis to make the Frege IDE workspace/project-aware and satisfy the usability quality attribute.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">The three <code>Global monads in the Frege compiler</code></div>
<div id="diag-global-monads" class="imageblock kroki">
<div class="content">
<img src="_images/diag-405629367318b237db560227bf2e12dee1102683.svg" alt="The three `Global monads` in the Frege comiler. The `StG` is pure, while the `StIO Global` and `IO Global` are impure, beautifully showing the separation of concerns. We can switch from the `StG` to the `StIO Global` monad with the `liftStG` function and from `StIO Global` to `IO Global` with the `evalStateT` function. There also exist the two convenient get global state functions getST for `StG` and `getSTT` for `StIO Global`.">
</div>
<div class="title">Figure 3. The three <code>Global monads</code> in the Frege comiler. The <code>StG</code> is pure, while the <code>StIO Global</code> and <code>IO Global</code> are impure, beautifully showing the separation of concerns. We can switch from the <code>StG</code> to the <code>StIO Global</code> monad with the <code>liftStG</code> function and from <code>StIO Global</code> to <code>IO Global</code> with the <code>evalStateT</code> function. There also exist the two convenient get global state functions getST for <code>StG</code> and <code>getSTT</code> for <code>StIO Global</code>.</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pure_hover_core"><a class="anchor" href="#_pure_hover_core"></a>Pure Hover Core</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#hover-component-seq">Figure 4</a> shows the sequence diagram for the hover component.</p>
</div>
<div id="hover-component-seq" class="imageblock kroki">
<div class="content">
<img src="_images/diag-7d6a87084a26be043162d2781a00eddf1deee055.svg" alt="Hovering over an expression in the text editor calls the LSP component, which finds the global for the Frege file and delegates the call to the Hover component. The Hover component extracts the type signature from the global, transforms it to the LSP type Hover and returns it to the LSP, which forwards it back to the text editor.">
</div>
<div class="title">Figure 4. Hovering over an expression in the text editor calls the LSP component, which finds the global for the Frege file and delegates the call to the Hover component. The Hover component extracts the type signature from the global, transforms it to the LSP type Hover and returns it to the LSP, which forwards it back to the text editor.</div>
</div>
<div class="paragraph">
<p>The Hover component is layered according to the <a href="principles.html#fregeCore" class="xref page">Write Core Logic in Frege, Use Java for LSP</a> principle and shown in <a href="#hover-layers-seq">Figure 5</a>.</p>
</div>
<div id="hover-layers-seq" class="imageblock kroki">
<div class="content">
<img src="_images/diag-1bae654cf125b53c2da0566e73ac67a6f89c1a62.svg" alt="Hover layers: The `HoverService.java` class creates the Frege `PositionLSP` type and calls the `HoverLSP.fr` module. The `HoverLSP.fr` module converts the `PositionLSP` type to the core `Position` type to make the core logic data types independent of the LSP types. It then calls the `Hover.fr` module to compute the type signature, which is returned as `Maybe Hover` signaling that there may be no available type for the requested hover expression. As a final step the core data type `Maybe Hover` is transformed back to the `Maybe HoverLSP` type and returned to the `HoverService.java` class. The whole interaction is pure because there is no `IO` involved.">
</div>
<div class="title">Figure 5. Hover layers: The <code>HoverService.java</code> class creates the Frege <code>PositionLSP</code> type and calls the <code>HoverLSP.fr</code> module. The <code>HoverLSP.fr</code> module converts the <code>PositionLSP</code> type to the core <code>Position</code> type to make the core logic data types independent of the LSP types. It then calls the <code>Hover.fr</code> module to compute the type signature, which is returned as <code>Maybe Hover</code> signaling that there may be no available type for the requested hover expression. As a final step the core data type <code>Maybe Hover</code> is transformed back to the <code>Maybe HoverLSP</code> type and returned to the <code>HoverService.java</code> class. The whole interaction is pure because there is no <code>IO</code> involved.</div>
</div>
<div class="paragraph">
<p>The <code>getTypeOnHover</code> function is responsible for the main work and shown in <a href="#code-getTypeOnHover">Listing 1</a>.</p>
</div>
<div id="code-getTypeOnHover" class="listingblock">
<div class="title">Listing 1. The <code>getTypeOnHover</code> Function</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-haskell hljs" data-lang="haskell">getTypeOnHover :: Position -&gt; StateT Global Maybe Hover <i class="conum" data-value="1"></i><b>(1)</b>
getTypeOnHover pos = do
    global     &lt;- StateT.get
    token      &lt;- findToken pos <i class="conum" data-value="2"></i><b>(2)</b>
    qname      &lt;- tokenToQName token <i class="conum" data-value="2"></i><b>(2)</b>
    symbol     &lt;- findSymbol qname <i class="conum" data-value="2"></i><b>(2)</b>
    symbolType &lt;- getSymbolType symbol <i class="conum" data-value="2"></i><b>(2)</b>
    pure        $ Hover <i class="conum" data-value="3"></i><b>(3)</b>
        {
            range   = tokenToRange token,
            content = FregeCodeBlock symbolType
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The function uses the monad transformer concept to combine the <code>State Global</code> and the <code>Maybe Hover</code> monad.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The main logicWe find the needed type in the big <code>Global</code> record by moving from <code>token &#8594; qualifiedName &#8594; symbol &#8594; symbolType</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>As a last step, we transform the result to our core data type <code>Hover</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since the core is pure and since we developed it with a <a href="principles.html#_test_driven_development" class="xref page">Test-Driven Development</a> approach it is testable as shown <a href="#code-hover-test">Listing 2</a>.</p>
</div>
<div id="code-hover-test" class="listingblock">
<div class="title">Listing 2. A Hover test case checking the type signature of a string constant</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-haskell hljs" data-lang="haskell">shouldShowLocalVaridTypeSignature :: Property
shouldShowLocalVaridTypeSignature = once $ morallyDubiousIOProperty do <i class="conum" data-value="1"></i><b>(1)</b>
    fregeHoverCode  = "module HoverTest where\n\n"
                   ++ "simplyString = \"Hello\""
    global         &lt;- standardCompileGlobal
    compiledGlobal &lt;- compile fregeHoverCode global
    expected        = Just Hover
        {
            range   = Range { start = Position 3 1, end = Position 3 13 },
            content = FregeCodeBlock "simplyString :: String"
        }
    actual          = getTypeSignatureOnHover (Position 3 3) compiledGlobal
    pure            $ expected == actual</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The acute reader might notice the <code>morallyDubiousIOProperty</code> and think that the test is not pure. You are right: For the test setup we need to compile the code first, which is as illustrated the impure first step. Since a pure function cannot call an impure function in Frege, we need to execute the whole test in the impure <code>IO</code> context. The <code>getTypeOnHover</code> function, however, remains pure.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_impure_output"><a class="anchor" href="#_impure_output"></a>Impure Output</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This last step is delegated to the <a href="https://github.com/eclipse/lsp4j">LSP4J</a> library. As a result, we just follow the guidelines and implement the hover binding as shown in <a href="constraints.html#lsp4j" class="xref page">Constraints</a>.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
